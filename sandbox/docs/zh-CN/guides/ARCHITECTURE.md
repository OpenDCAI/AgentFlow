# HTTP Service é¡¹ç›®æ¶æ„æ€»ç»“

> **ç›¸å…³æ–‡æ¡£**:
> - æœ¬æ–‡æ¡£ï¼šç³»ç»Ÿæ•´ä½“æ¶æ„æ¦‚è§ˆ
> - [åç«¯å¼€å‘è¯¦ç»†æŒ‡å—](../development/BACKEND_DEVELOPMENT.md)ï¼šå®Œæ•´çš„åç«¯å¼€å‘æ•™ç¨‹å’Œç¤ºä¾‹
> - [ä½¿ç”¨æŒ‡å—](USAGE_GUIDE.md)ï¼šSandbox ä½¿ç”¨ä¸å¯åŠ¨æ–¹å¼

## ğŸ“‹ ç›®å½•

1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
3. [æ•°æ®æµ](#æ•°æ®æµ)
4. [ç”Ÿå‘½å‘¨æœŸç®¡ç†](#ç”Ÿå‘½å‘¨æœŸç®¡ç†)
5. [Session ç®¡ç†æœºåˆ¶](#session-ç®¡ç†æœºåˆ¶)
6. [å·¥å…·æ³¨å†Œæœºåˆ¶](#å·¥å…·æ³¨å†Œæœºåˆ¶)
7. [åç«¯æ‰©å±•ç³»ç»Ÿ](#åç«¯æ‰©å±•ç³»ç»Ÿ)
8. [é…ç½®ç³»ç»Ÿ](#é…ç½®ç³»ç»Ÿ)
9. [API æ¥å£](#api-æ¥å£)

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ç”¨æˆ·å±‚ (User Layer)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Sandbox (Facade)                              â”‚   â”‚
â”‚  â”‚  - ç»Ÿä¸€å…¥å£ï¼Œç®€åŒ–ç”¨æˆ·äº¤äº’                                          â”‚   â”‚
â”‚  â”‚  - è‡ªåŠ¨æœåŠ¡å™¨å¯åŠ¨/æ£€æµ‹                                             â”‚   â”‚
â”‚  â”‚  - æ”¯æŒåŒæ­¥/å¼‚æ­¥åŒæ¨¡å¼                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                           â”‚
â”‚                              â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              HTTPServiceClient (HTTP Client)                     â”‚   â”‚
â”‚  â”‚  - HTTP è¯·æ±‚å°è£…                                                 â”‚   â”‚
â”‚  â”‚  - Worker ID ç®¡ç†                                                â”‚   â”‚
â”‚  â”‚  - è‡ªåŠ¨é‡è¯•/é”™è¯¯å¤„ç†                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                           â”‚
â”‚                              â”‚ HTTP/JSON                                  â”‚
â”‚                              â–¼                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æœåŠ¡å±‚ (Server Layer)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              HTTPServiceServer (FastAPI)                          â”‚   â”‚
â”‚  â”‚  - æŒæœ‰å·¥å…·æ•°æ®ç»“æ„ï¼ˆä¸‰å±‚æ˜ å°„ï¼‰                                    â”‚   â”‚
â”‚  â”‚  - æŒæœ‰ Backend å®ä¾‹                                              â”‚   â”‚
â”‚  â”‚  - åå°„æ‰«æ @tool æ ‡è®°å¹¶æ³¨å†Œ                                       â”‚   â”‚
â”‚  â”‚  - HTTP è·¯ç”± (routes.py)                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                              â”‚                                           â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚        â–¼                                             â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  ToolExecutor    â”‚                    â”‚ ResourceRouter   â”‚          â”‚
â”‚  â”‚  - å·¥å…·æ‰§è¡Œ      â”‚                    â”‚  - Session ç®¡ç†   â”‚          â”‚
â”‚  â”‚  - è·¯ç”±è§£æ      â”‚                    â”‚  - èµ„æºè·¯ç”±       â”‚          â”‚
â”‚  â”‚  - å‚æ•°æ³¨å…¥      â”‚                    â”‚  - ä¸´æ—¶ Session   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â”‚                                           â”‚
â”‚                              â–¼                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    Backend System                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚ VMBackend    â”‚  â”‚ RAGBackend   â”‚  â”‚ API Tools    â”‚          â”‚   â”‚
â”‚  â”‚  â”‚ (Session)    â”‚  â”‚ (å…±äº«èµ„æº)   â”‚  â”‚ (è½»é‡çº§)     â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. Sandbox (ç”¨æˆ·é—¨é¢)

**ä½ç½®**: `sandbox/sandbox.py`

**èŒè´£**:
- æä¾›ç»Ÿä¸€çš„ç”¨æˆ·æ¥å£
- å°è£… `HTTPServiceClient`
- è‡ªåŠ¨æœåŠ¡å™¨å¯åŠ¨/æ£€æµ‹
- Session æ‰¹é‡åˆ›å»ºç®¡ç†
- æ”¯æŒåŒæ­¥/å¼‚æ­¥åŒæ¨¡å¼

**å…³é”®æ–¹æ³•**:
```python
- start()                    # å¯åŠ¨æœåŠ¡å™¨ï¼ˆè§¦å‘ Backend.warmupï¼‰
- warmup()                   # æ˜¾å¼é¢„çƒ­åç«¯èµ„æº
- get_warmup_status()        # è·å–é¢„çƒ­çŠ¶æ€
- create_session()           # åˆ›å»º Sessionï¼ˆè§¦å‘ Backend.initializeï¼‰
- execute()                  # æ‰§è¡Œå·¥å…·ï¼ˆå¯è‡ªåŠ¨åˆ›å»ºä¸´æ—¶ Sessionï¼Œè‡ªåŠ¨é¢„çƒ­ï¼‰
- destroy_session()          # é”€æ¯ Sessionï¼ˆè§¦å‘ Backend.cleanupï¼‰
- close()                    # å…³é—­è¿æ¥
- shutdown_server()          # å…³é—­æœåŠ¡å™¨ï¼ˆè§¦å‘ Backend.shutdownï¼‰
```

### 2. HTTPServiceServer (HTTP æœåŠ¡å™¨)

**ä½ç½®**: `sandbox/server/app.py`

**èŒè´£**:
- **æŒæœ‰å·¥å…·æ•°æ®ç»“æ„**ï¼ˆä¸‰å±‚æ˜ å°„ï¼‰
- **æŒæœ‰ Backend å®ä¾‹**
- åå°„æ‰«æ @tool æ ‡è®°å¹¶æ³¨å†Œ
- è°ƒåº¦è¯·æ±‚åˆ°å¯¹åº”çš„å·¥å…·å‡½æ•°
- ç®¡ç†åç«¯ç”Ÿå‘½å‘¨æœŸ

**æ•°æ®ç»“æ„**:
```python
# ä¸‰å±‚å·¥å…·æ˜ å°„ï¼ˆServer æŒæœ‰ï¼‰
self._tools: Dict[str, Callable]           # å®Œæ•´åç§° â†’ å‡½æ•°
self._tool_name_index: Dict[str, List[str]] # ç®€å•åç§° â†’ å®Œæ•´åç§°åˆ—è¡¨
self._tool_resource_types: Dict[str, str]   # å®Œæ•´åç§° â†’ èµ„æºç±»å‹

# Backend å®ä¾‹æŒæœ‰
self._backends: Dict[str, Backend]          # èµ„æºç±»å‹ â†’ Backend å®ä¾‹
```

### 3. ToolExecutor (å·¥å…·æ‰§è¡Œå™¨)

**ä½ç½®**: `sandbox/server/core/tool_executor.py`

**èŒè´£**:
- å·¥å…·æ‰§è¡Œé€»è¾‘
- èµ„æºç±»å‹å‰ç¼€è§£æ
- Session è‡ªåŠ¨æ³¨å…¥
- **ä¸´æ—¶ Session ç®¡ç†**ï¼ˆç”¨å®Œå³é”€æ¯ï¼‰

**æ‰§è¡Œæµç¨‹**:
```python
# 1. è§£æèµ„æºç±»å‹å‰ç¼€
action = "vm:screenshot"
  â†’ resource_type = "vm"
  â†’ tool_name = "screenshot"

# 2. è·å–/åˆ›å»º Session
if resource_type:
    existing = router.get_session(worker_id, resource_type)
    if existing:
        session_info = existing
        is_temporary = False
    else:
        session_info = router.create_session(...)
        is_temporary = True  # ä¸´æ—¶ Session

# 3. æ‰§è¡Œå·¥å…·
result = await func(**params)

# 4. ä¸´æ—¶ Session è‡ªåŠ¨é”€æ¯
if is_temporary:
    await router.destroy_session(...)
```

### 4. ResourceRouter (èµ„æºè·¯ç”±å™¨)

**ä½ç½®**: `sandbox/server/core/resource_router.py`

**èŒè´£**:
- Session ç”Ÿå‘½å‘¨æœŸç®¡ç†
- Worker èµ„æºéš”ç¦»
- æ³¨å†Œ Backend çš„ initialize/cleanup å‡½æ•°
- è¿‡æœŸ Session æ¸…ç†

---

## ğŸ”„ æ•°æ®æµ

### æ‰§è¡Œå‘½ä»¤æµç¨‹

```
ç”¨æˆ·ä»£ç 
  â”‚
  â”‚ sandbox.execute("vm:screenshot", {})
  â–¼
Sandbox.execute()
  â”‚
  â”‚ await client.execute("vm:screenshot", {})
  â–¼
HTTPServiceClient.execute()
  â”‚
  â”‚ POST /execute
  â”‚ Body: {"worker_id": "...", "action": "vm:screenshot", "params": {}}
  â–¼
HTTPServiceServer (routes.py)
  â”‚
  â”‚ await server.execute(action, params, worker_id)
  â–¼
ToolExecutor.execute()
  â”‚
  â”‚ 1. è§£æ: "vm:screenshot" â†’ resource_type="vm"
  â”‚ 2. æŸ¥æ‰¾å·¥å…·: func = _tools["vm:screenshot"]
  â”‚ 3. è·å–/åˆ›å»º Sessionï¼ˆå¯èƒ½æ˜¯ä¸´æ—¶çš„ï¼‰
  â”‚ 4. æ³¨å…¥å‚æ•°: params["session_info"] = session_info
  â”‚ 5. æ‰§è¡Œ: result = await func(**params)
  â”‚ 6. å¦‚æœä¸´æ—¶ Session â†’ è‡ªåŠ¨é”€æ¯
  â–¼
è¿”å›ç»“æœ
  â”‚
  â”‚ {"success": True, "data": {...}, "temporary_session": True/False}
  â–¼
ç”¨æˆ·ä»£ç 
```

---

## ğŸ“… ç”Ÿå‘½å‘¨æœŸç®¡ç†

### Backend ç”Ÿå‘½å‘¨æœŸæ–¹æ³•

| æ–¹æ³• | è°ƒç”¨æ—¶æœº | è§¦å‘è€… | ä½œç”¨ |
|------|---------|--------|------|
| `warmup()` | æœåŠ¡å™¨å¯åŠ¨æˆ–æ˜¾å¼è°ƒç”¨ | `sandbox.warmup()` æˆ–æ‰§è¡Œå·¥å…·æ—¶è‡ªåŠ¨è§¦å‘ | é¢„çƒ­å…±äº«èµ„æºï¼ˆèµ„æºæ± ã€æ¨¡å‹åŠ è½½ï¼‰ |
| `initialize()` | åˆ›å»º Session | `create_session()` æˆ–è‡ªåŠ¨åˆ›å»º | åˆ†é… worker ä¸“å±èµ„æº |
| `cleanup()` | é”€æ¯ Session | `destroy_session()` æˆ–è‡ªåŠ¨é”€æ¯ | å›æ”¶ worker èµ„æº |
| `shutdown()` | æœåŠ¡å™¨å…³é—­ | `shutdown_server()` | é‡Šæ”¾æ‰€æœ‰å…±äº«èµ„æº |

### è‡ªåŠ¨é¢„çƒ­æœºåˆ¶

æ‰§è¡Œå·¥å…·æ—¶ï¼Œå¦‚æœåç«¯å°šæœªé¢„çƒ­ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è§¦å‘é¢„çƒ­ï¼š

```python
# æ‰§è¡Œæµç¨‹ï¼ˆè‡ªåŠ¨é¢„çƒ­ï¼‰
await sandbox.execute("rag:search", {"query": "test"})
# 1. æ£€æŸ¥ RAG åç«¯æ˜¯å¦å·²é¢„çƒ­
# 2. æœªé¢„çƒ­ â†’ è‡ªåŠ¨è°ƒç”¨ backend.warmup()
# 3. æ‰§è¡Œå·¥å…·
```

ä¹Ÿå¯ä»¥æ˜¾å¼é¢„çƒ­ä»¥å‡å°‘é¦–æ¬¡è°ƒç”¨å»¶è¿Ÿï¼š

```python
# æ˜¾å¼é¢„çƒ­
await sandbox.warmup(["rag", "vm"])  # é¢„çƒ­æŒ‡å®šåç«¯
await sandbox.warmup()                # é¢„çƒ­æ‰€æœ‰åç«¯

# è·å–é¢„çƒ­çŠ¶æ€
status = await sandbox.get_warmup_status()
# {"backends": {"rag": {"loaded": True, "warmed_up": True}, ...}}
```

### ç”Ÿå‘½å‘¨æœŸæ—¶åºå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Œæ•´ç”Ÿå‘½å‘¨æœŸæ—¶åº                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   sandbox.start()                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â””â”€â”€ server.load_backend(backend)                           â”‚
â”‚               â”‚                                                  â”‚
â”‚               â””â”€â”€ scan_and_register(backend)  â† æ³¨å†Œå·¥å…·         â”‚
â”‚                                                                  â”‚
â”‚   sandbox.warmup(["rag", "vm"])     â† æ˜¾å¼é¢„çƒ­ï¼ˆå¯é€‰ï¼‰           â”‚
â”‚       â”‚                                                          â”‚
â”‚       â””â”€â”€ await backend.warmup()                                 â”‚
â”‚                                                                  â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                  â”‚
â”‚   sandbox.execute("rag:search", {})                              â”‚
â”‚       â”‚                                                          â”‚
â”‚       â”œâ”€â”€ (è‡ªåŠ¨) await backend.warmup()  â† è‹¥åç«¯æœªé¢„çƒ­          â”‚
â”‚       â””â”€â”€ æ‰§è¡Œå·¥å…·å‡½æ•°                                           â”‚
â”‚                                                                  â”‚
â”‚   sandbox.create_session("vm", config)                           â”‚
â”‚       â”‚                                                          â”‚
â”‚       â””â”€â”€ await backend.initialize(worker_id, config)  â† â­      â”‚
â”‚                                                                  â”‚
â”‚   sandbox.execute("vm:screenshot", {})                           â”‚
â”‚       â”‚                                                          â”‚
â”‚       â””â”€â”€ ä½¿ç”¨ç°æœ‰ Session æ‰§è¡Œ                                  â”‚
â”‚                                                                  â”‚
â”‚   sandbox.destroy_session("vm")                                  â”‚
â”‚       â”‚                                                          â”‚
â”‚       â””â”€â”€ await backend.cleanup(worker_id, session_info)  â† â­   â”‚
â”‚                                                                  â”‚
â”‚   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                                                                  â”‚
â”‚   sandbox.close()                                                â”‚
â”‚       â”‚                                                          â”‚
â”‚       â””â”€â”€ åªå…³é—­å®¢æˆ·ç«¯è¿æ¥ï¼ŒæœåŠ¡å™¨ç»§ç»­è¿è¡Œ                       â”‚
â”‚                                                                  â”‚
â”‚   sandbox.shutdown_server()                                      â”‚
â”‚       â”‚                                                          â”‚
â”‚       â””â”€â”€ await backend.shutdown()  â† â­ é‡Šæ”¾ GPU ç­‰èµ„æº         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Sandbox API ä¸ Backend ç”Ÿå‘½å‘¨æœŸå¯¹åº”

| Sandbox API | Backend æ–¹æ³• | è¯´æ˜ |
|-------------|-------------|------|
| `start()` | `warmup()` (å¯é€‰) | å¯åŠ¨æœåŠ¡å™¨ï¼Œå¯é€‰é¢„çƒ­åç«¯ |
| `warmup(resources)` | `warmup()` | æ˜¾å¼é¢„çƒ­åç«¯èµ„æº |
| `get_warmup_status()` | - | è·å–é¢„çƒ­çŠ¶æ€ |
| `create_session(type, config)` | `initialize(worker_id, config)` | æ˜¾å¼åˆ›å»º Session |
| `execute(action, params)` | `warmup()` (è‡ªåŠ¨) + å·¥å…·å‡½æ•° + å¯èƒ½çš„ `initialize`/`cleanup` | æ‰§è¡Œï¼ˆè‡ªåŠ¨é¢„çƒ­ï¼Œå¯è‡ªåŠ¨åˆ›å»ºä¸´æ—¶ Sessionï¼‰ |
| `destroy_session(type)` | `cleanup(worker_id, session_info)` | æ˜¾å¼é”€æ¯ Session |
| `close()` | - | å…³é—­å®¢æˆ·ç«¯è¿æ¥ï¼ˆæœåŠ¡å™¨ç»§ç»­è¿è¡Œï¼‰ |
| `shutdown_server()` | `shutdown()` | å…³é—­æœåŠ¡å™¨ï¼ˆé‡Šæ”¾ GPU ç­‰èµ„æºï¼‰ |

---

## ğŸ“¦ Session ç®¡ç†æœºåˆ¶

### ä¸¤ç§ Session æ¨¡å¼

| æ¨¡å¼ | åˆ›å»ºæ–¹å¼ | æ‰§è¡Œå | é€‚ç”¨åœºæ™¯ |
|------|---------|--------|---------|
| **æ˜¾å¼åˆ›å»ºï¼ˆå¤ç”¨æ¨¡å¼ï¼‰** | `create_session()` | ä¿æŒå­˜æ´» | å¤šæ¬¡æ“ä½œåŒä¸€èµ„æº |
| **è‡ªåŠ¨åˆ›å»ºï¼ˆä¸´æ—¶æ¨¡å¼ï¼‰** | æ‰§è¡Œæ—¶è‡ªåŠ¨ | ç«‹å³é”€æ¯ | å•æ¬¡æ“ä½œ |

### æ˜¾å¼åˆ›å»º Session

```python
async with Sandbox() as sandbox:
    # æ˜¾å¼åˆ›å»º - ä¼šå¤ç”¨
    await sandbox.create_session("vm", {
        "screen_size": [1920, 1080],
        "custom_name": "my_vm"
    })
    
    await sandbox.execute("vm:screenshot", {})  # å¤ç”¨
    await sandbox.execute("vm:click", {"x": 100})  # å¤ç”¨
    
    await sandbox.destroy_session("vm")
```

### è‡ªåŠ¨åˆ›å»ºä¸´æ—¶ Session

```python
async with Sandbox() as sandbox:
    # ç›´æ¥æ‰§è¡Œï¼Œè‡ªåŠ¨åˆ›å»ºä¸´æ—¶ Session
    await sandbox.execute("vm:screenshot", {})
    # Session å·²è‡ªåŠ¨é”€æ¯
```

### è¿”å›ç»“æœå­—æ®µ

```json
{
    "success": true,
    "data": {...},
    "tool": "screenshot",
    "resource_type": "vm",
    "session_id": "xxx",
    "temporary_session": true
}
```

> è¯´æ˜ï¼š`create_session` çš„é…ç½®ä¼šåœ¨ ResourceRouter å±‚ä¸é»˜è®¤é…ç½®åˆå¹¶ï¼Œ
> ç”¨æˆ·ä¼ å…¥å­—æ®µä¼šè¦†ç›–é»˜è®¤å€¼ã€‚

---

## ğŸ”Œ å·¥å…·æ³¨å†Œæœºåˆ¶

### ä¸¤ç§æ³¨å†Œæ–¹å¼

| æ–¹å¼ | è£…é¥°å™¨ | é€‚ç”¨äº | æ³¨å†Œæ—¶æœº |
|------|--------|--------|---------|
| **é‡é‡çº§åç«¯** | `@tool` | Backend ç±»æ–¹æ³• | `load_backend()` åå°„æ‰«æ |
| **è½»é‡çº§å·¥å…·** | `@register_api_tool` | ç‹¬ç«‹å‡½æ•° | æ¨¡å—å¯¼å…¥æ—¶ |

### é‡é‡çº§åç«¯å·¥å…·

```python
# ä½¿ç”¨ @tool è£…é¥°å™¨æ ‡è®°
class VMBackend(Backend):
    @tool("vm:screenshot")
    async def screenshot(self, session_info: Dict) -> Dict:
        vm = session_info["data"]["vm"]
        return {"image": await vm.capture()}

# Server åŠ è½½æ—¶åå°„æ‰«æ
server.load_backend(VMBackend())
# â†’ scan_and_register() å‘ç° @tool æ ‡è®°
# â†’ æ³¨å†Œåˆ° _tools["vm:screenshot"]
```

### è½»é‡çº§ API å·¥å…·

```python
# ä½¿ç”¨ @register_api_tool è£…é¥°å™¨
@register_api_tool("search", config_key="websearch")
async def search(query: str, **config) -> Dict:
    api_key = config.get("api_key")
    return {"results": [...]}

# æ¨¡å—å¯¼å…¥æ—¶è‡ªåŠ¨æ³¨å†Œåˆ°å…¨å±€ _API_TOOLS
# ConfigLoader._load_api_tools() å°†å…¶æ³¨å†Œåˆ° Server
```

### å·¥å…·æ•°æ®ç»“æ„

```python
# Server æŒæœ‰çš„ä¸‰å±‚æ˜ å°„
_tools = {
    "search": <wrapper func>,           # è½»é‡çº§å·¥å…·
    "vm:screenshot": <bound method>,    # é‡é‡çº§å·¥å…·
}

_tool_name_index = {
    "search": ["search"],
    "screenshot": ["vm:screenshot"],
}

_tool_resource_types = {
    "vm:screenshot": "vm",
    # "search" ä¸åœ¨è¿™é‡Œï¼ˆæ—  resource_typeï¼‰
}
```

---

## ğŸ¨ åç«¯æ‰©å±•ç³»ç»Ÿ

### Backend ç»Ÿä¸€åŸºç±»

```python
class Backend(ABC):
    """
    åç«¯åŸºç±» - æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯å¯é€‰çš„
    """
    name: str           # åç«¯åç§°
    description: str    # æè¿°
    version: str        # ç‰ˆæœ¬
    
    # å…¨å±€ç”Ÿå‘½å‘¨æœŸï¼ˆå¯é€‰ï¼‰
    async def warmup(self) -> None: pass
    async def shutdown(self) -> None: pass
    
    # Session ç”Ÿå‘½å‘¨æœŸï¼ˆå¯é€‰ï¼‰
    async def initialize(self, worker_id, config) -> Dict: ...
    async def cleanup(self, worker_id, session_info) -> None: ...
```

### ä¸‰ç§ Backend ç±»å‹

| ç±»å‹ | å®ç°çš„æ–¹æ³• | é€‚ç”¨åœºæ™¯ | ç¤ºä¾‹ |
|------|-----------|---------|------|
| **å…±äº«èµ„æºåç«¯** | `warmup()`, `shutdown()` | é¢„çƒ­æ¨¡å‹ã€è¿æ¥æ±  | RAG |
| **Session èµ„æºåç«¯** | `initialize()`, `cleanup()` | æ¯ worker ç‹¬ç«‹å®ä¾‹ | VM, Bash |
| **æ··åˆåç«¯** | å…¨éƒ¨å››ä¸ª | å…±äº« + Session | Browser |

### å­˜æ”¾ä½ç½®

```
backends/
â”œâ”€â”€ base.py              # Backend åŸºç±»
â”œâ”€â”€ resources/           # é‡é‡çº§åç«¯
â”‚   â”œâ”€â”€ vm.py            # Session åç«¯ï¼ˆVM æ¡Œé¢è‡ªåŠ¨åŒ–ï¼‰
â”‚   â”œâ”€â”€ rag.py           # å…±äº«èµ„æºåç«¯ï¼ˆRAG æ£€ç´¢ï¼‰
â”‚   â”œâ”€â”€ bash.py          # Session åç«¯ï¼ˆBash ç»ˆç«¯ï¼‰
â”‚   â”œâ”€â”€ browser.py       # æ··åˆåç«¯ï¼ˆæµè§ˆå™¨è‡ªåŠ¨åŒ–ï¼‰
â”‚   â””â”€â”€ code_executor.py # Session åç«¯ï¼ˆä»£ç æ‰§è¡Œï¼‰
â””â”€â”€ tools/               # è½»é‡çº§ API å·¥å…·
    â”œâ”€â”€ __init__.py      # @register_api_tool
    â””â”€â”€ websearch.py     # WebSearch å·¥å…·
```

---

## âš™ï¸ é…ç½®ç³»ç»Ÿ

### é…ç½®ç»“æ„

```json
{
  "server": {
    "title": "Sandbox HTTP Service",
    "session_ttl": 300
  },
  
  "resources": {
    "vm": {
      "enabled": true,
      "backend_class": "sandbox.server.backends.resources.vm.VMBackend",
      "config": {"pool_size": 10}
    }
  },
  
  "apis": {
    "websearch": {
      "serper_api_key": "${SERPER_API_KEY}",
      "max_results": 10
    }
  }
}
```

### ç¯å¢ƒå˜é‡æ”¯æŒ

- `${VAR}` - å¿…éœ€çš„ç¯å¢ƒå˜é‡
- `${VAR:-default}` - å¸¦é»˜è®¤å€¼

---

## ğŸ”Œ API æ¥å£

### æ ¸å¿ƒç«¯ç‚¹

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/execute` | POST | æ‰§è¡Œå·¥å…· |
| `/execute/batch` | POST | æ‰¹é‡æ‰§è¡Œ |
| `/session/create` | POST | åˆ›å»º Session |
| `/session/destroy` | POST | é”€æ¯ Session |
| `/session/list` | POST | åˆ—å‡º Session |
| `/tools` | GET | åˆ—å‡ºå·¥å…· |
| `/health` | GET | å¥åº·æ£€æŸ¥ |

### æ‰§è¡Œå“åº”

```json
{
  "success": true,
  "data": {"image": "..."},
  "tool": "screenshot",
  "resource_type": "vm",
  "session_id": "vm_xxx_001",
  "temporary_session": false,
  "execution_time_ms": 15.5
}
```

---

## ğŸ¯ å…³é”®è®¾è®¡åŸåˆ™

### 1. åˆ†å±‚è§£è€¦

- **Server**ï¼šæŒæœ‰æ•°æ®ç»“æ„ï¼Œè°ƒç”¨é«˜å±‚æ¥å£
- **Backend**ï¼šéšè—å¤æ‚å®ç°ï¼ˆèµ„æºæ± ã€æ¨¡å‹ç­‰ï¼‰
- **ToolExecutor**ï¼šçº¯æ‰§è¡Œé€»è¾‘

### 2. å¼€æ”¾æ¥å£ï¼Œéšè—å®ç°

```
Server åªçŸ¥é“:
â”œâ”€â”€ backend.warmup()      â†’ é¢„çƒ­
â”œâ”€â”€ backend.initialize()  â†’ åˆ›å»º Session
â”œâ”€â”€ backend.cleanup()     â†’ é”€æ¯ Session
â””â”€â”€ backend.shutdown()    â†’ å…³é—­

Server ä¸çŸ¥é“:
â”œâ”€â”€ èµ„æºæ± å¦‚ä½•å®ç°
â”œâ”€â”€ VM æ˜¯æ–°å»ºè¿˜æ˜¯å¤ç”¨
â”œâ”€â”€ æ¨¡å‹å¦‚ä½•åŠ è½½
â””â”€â”€ è¿æ¥å¦‚ä½•ç®¡ç†
```

### 3. çµæ´»çš„ Session ç®¡ç†

- æ˜¾å¼åˆ›å»ºï¼šé€‚åˆå¤šæ¬¡æ“ä½œ
- è‡ªåŠ¨åˆ›å»ºï¼šé€‚åˆå•æ¬¡æ“ä½œ
- ä¸´æ—¶ Sessionï¼šç”¨å®Œå³é”€æ¯

### 4. ç»Ÿä¸€çš„å·¥å…·æ³¨å†Œ

- é‡é‡çº§ï¼š`@tool` + åå°„æ‰«æ
- è½»é‡çº§ï¼š`@register_api_tool` + é…ç½®æ³¨å…¥

**å¿«é€Ÿå†³ç­–**ï¼šéœ€è¦é•¿è¿æ¥æˆ–æŒä¹…çŠ¶æ€ï¼Ÿâ†’ Backendï¼›å¦åˆ™ â†’ APITool

è¯¦ç»†å†³ç­–æ ‘è¯·å‚è€ƒ [å·¥å…·æ³¨å†ŒæŒ‡å—](../doc/REGISTRATION_GUIDE.md#-å†³ç­–æ ‘é€‰æ‹©-backend-è¿˜æ˜¯-apitool)ã€‚

### 5. CI/CD éªŒè¯

ç”±äºä½¿ç”¨åŠ¨æ€ç±»åŠ è½½ï¼Œå»ºè®®åœ¨ CI/CD ä¸­å¯ç”¨é…ç½®é¢„æ£€ï¼š

```bash
python -m sandbox server --config configs/profiles/production.json --validate
```

---

## ğŸ“Š é¡¹ç›®ç»“æ„

```
sandbox/
â”œâ”€â”€ __init__.py              # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ sandbox.py               # ç”¨æˆ·é—¨é¢ç±»
â”œâ”€â”€ client.py                # HTTP å®¢æˆ·ç«¯
â”‚
â”œâ”€â”€ server/                  # æœåŠ¡å™¨æ¨¡å—
â”‚   â”œâ”€â”€ app.py               # HTTPServiceServerï¼ˆæŒæœ‰æ•°æ®ç»“æ„ï¼‰
â”‚   â”œâ”€â”€ routes.py            # HTTP è·¯ç”±å®šä¹‰
â”‚   â”œâ”€â”€ config_loader.py     # é…ç½®åŠ è½½å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                # æ ¸å¿ƒç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ decorators.py    # @tool è£…é¥°å™¨
â”‚   â”‚   â”œâ”€â”€ tool_executor.py # å·¥å…·æ‰§è¡Œå™¨
â”‚   â”‚   â””â”€â”€ resource_router.py # èµ„æºè·¯ç”±å™¨
â”‚   â”‚
â”‚   â””â”€â”€ backends/            # åç«¯å®ç°
â”‚       â”œâ”€â”€ base.py          # Backend åŸºç±»
â”‚       â”œâ”€â”€ resources/       # é‡é‡çº§åç«¯ï¼ˆvm, rag, bash, browser, code_executorï¼‰
â”‚       â””â”€â”€ tools/           # è½»é‡çº§ API å·¥å…·ï¼ˆwebsearchï¼‰
â”‚
â”œâ”€â”€ configs/                 # é…ç½®æ–‡ä»¶
â””â”€â”€ USAGE_GUIDE.md           # ä½¿ç”¨æŒ‡å—
```
